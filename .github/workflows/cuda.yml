name: CUDA CI

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["**"]
    types: [opened, reopened, synchronize, labeled, unlabeled]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  require-label:
    name: Require Run CI label
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Ensure Run CI label is present
        env:
          HAS_LABEL: ${{ contains(github.event.pull_request.labels.*.name, 'Run CI') }}
        run: |
          if [ "${HAS_LABEL}" != "true" ]; then
            echo "::error::Add the 'Run CI' label to this pull request to trigger CI."
            exit 1
          fi
        shell: bash

  # Build with different CUDA versions
  cuda-version-matrix:
    name: CUDA ${{ matrix.cuda }} (${{ matrix.build_type }})
    runs-on: ubuntu-22.04
    needs: [require-label]
    if: github.event_name != 'pull_request' || needs.require-label.result == 'success'
    strategy:
      fail-fast: false
      matrix:
        include:
          # CUDA 11.x versions
          - cuda: "11.8.0"
            build_type: Debug
            gcc: 11
          # CUDA 12.x versions
          - cuda: "12.4.1"
            build_type: Debug
            gcc: 12
          - cuda: "12.6.3"
            build_type: Debug
            gcc: 13

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Set up GCC ${{ matrix.gcc }}
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-${{ matrix.gcc }} g++-${{ matrix.gcc }}
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${{ matrix.gcc }} 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-${{ matrix.gcc }} 100
          gcc --version
          g++ --version

      - name: Install MPI
        run: |
          sudo apt-get install -y mpich libmpich-dev

      - name: Install CUDA Toolkit ${{ matrix.cuda }}
        uses: Jimver/cuda-toolkit@v0.2.23
        id: cuda-toolkit
        with:
          cuda: ${{ matrix.cuda }}
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas-dev", "cusparse", "cusparse-dev", "curand", "curand-dev", "cusolver", "cusolver-dev", "thrust"]'
          non-cuda-sub-packages: '["libcusparse-dev", "libcublas-dev", "libcurand-dev", "libcusolver-dev"]'

      - name: Verify CUDA installation
        run: |
          echo "CUDA path: ${{ steps.cuda-toolkit.outputs.CUDA_PATH }}"
          echo "CUDA version: ${{ steps.cuda-toolkit.outputs.cuda-version }}"
          nvcc --version
          which nvcc

      - name: Configure HYPRE with CUDA
        run: |
          cmake -S src -B build \
            -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
            -DHYPRE_ENABLE_CUDA=ON \
            -DHYPRE_ENABLE_CUSPARSE=ON \
            -DHYPRE_ENABLE_CUBLAS=ON \
            -DHYPRE_ENABLE_CURAND=ON \
            -DHYPRE_ENABLE_CUSOLVER=ON \
            -DHYPRE_BUILD_UMPIRE=ON \
            -DHYPRE_BUILD_TESTS=ON \
            -DCMAKE_CUDA_ARCHITECTURES="70;80" \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++

      - name: Build HYPRE
        run: cmake --build build --parallel $(nproc)

  # Test with shared library build
  cuda-shared-library:
    name: CUDA Shared Library
    runs-on: ubuntu-22.04
    needs: [require-label]
    if: github.event_name != 'pull_request' || needs.require-label.result == 'success'

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-12 g++-12 mpich libmpich-dev
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.23
        with:
          cuda: "12.4.1"
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas-dev", "cusparse", "cusparse-dev", "curand", "curand-dev", "cusolver", "cusolver-dev", "thrust"]'

      - name: Configure HYPRE with CUDA (Shared Library)
        run: |
          cmake -S src -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_SHARED_LIBS=ON \
            -DHYPRE_ENABLE_CUDA=ON \
            -DHYPRE_ENABLE_CUSPARSE=ON \
            -DHYPRE_ENABLE_CUBLAS=ON \
            -DHYPRE_ENABLE_CURAND=ON \
            -DHYPRE_ENABLE_CUSOLVER=ON \
            -DHYPRE_BUILD_TESTS=ON \
            -DCMAKE_CUDA_ARCHITECTURES="70;80"

      - name: Build HYPRE
        run: cmake --build build --parallel $(nproc)

  

  # Test with mixed integer type
  cuda-mixedint:
    name: CUDA Mixed Integer Type
    runs-on: ubuntu-22.04
    needs: [require-label]
    if: github.event_name != 'pull_request' || needs.require-label.result == 'success'

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-12 g++-12 mpich libmpich-dev
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.23
        with:
          cuda: "12.4.1"
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas-dev", "cusparse", "cusparse-dev", "curand", "curand-dev", "cusolver", "cusolver-dev", "thrust"]'

      - name: Configure HYPRE with CUDA Mixed Precision
        run: |
          cmake -S src -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DHYPRE_ENABLE_CUDA=ON \
            -DHYPRE_ENABLE_MIXEDINT=ON \
            -DHYPRE_ENABLE_CUSPARSE=ON \
            -DHYPRE_ENABLE_CUBLAS=ON \
            -DHYPRE_ENABLE_CURAND=ON \
            -DHYPRE_ENABLE_CUSOLVER=ON \
            -DHYPRE_BUILD_TESTS=ON \
            -DCMAKE_CUDA_ARCHITECTURES="70;80"

      - name: Build HYPRE
        run: cmake --build build --parallel $(nproc)

  # Test with single precision
  cuda-single-precision:
    name: CUDA Single Precision
    runs-on: ubuntu-22.04
    needs: [require-label]
    if: github.event_name != 'pull_request' || needs.require-label.result == 'success'

    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-12 g++-12 mpich libmpich-dev
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-12 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-12 100

      - name: Install CUDA Toolkit
        uses: Jimver/cuda-toolkit@v0.2.23
        with:
          cuda: "12.4.1"
          method: network
          sub-packages: '["nvcc", "cudart", "cublas", "cublas-dev", "cusparse", "cusparse-dev", "curand", "curand-dev", "cusolver", "cusolver-dev", "thrust"]'

      - name: Configure HYPRE with CUDA Single Precision
        run: |
          cmake -S src -B build \
            -DCMAKE_BUILD_TYPE=Debug \
            -DHYPRE_ENABLE_CUDA=ON \
            -DHYPRE_ENABLE_SINGLE=ON \
            -DHYPRE_ENABLE_CUSPARSE=ON \
            -DHYPRE_ENABLE_CUBLAS=ON \
            -DHYPRE_ENABLE_CURAND=ON \
            -DHYPRE_ENABLE_CUSOLVER=ON \
            -DHYPRE_BUILD_TESTS=ON \
            -DCMAKE_CUDA_ARCHITECTURES="70;80"

      - name: Build HYPRE
        run: cmake --build build --parallel $(nproc)


  # Summary job to track overall success
  cuda-ci-complete:
    name: CUDA CI Complete
    runs-on: ubuntu-latest
    needs:
      - cuda-version-matrix
      - cuda-shared-library
      - cuda-mixedint
      - cuda-single-precision
    if: always()
    steps:
      - name: Check all jobs passed
        run: |
          echo "CUDA Version Matrix: ${{ needs.cuda-version-matrix.result }}"
          echo "CUDA Shared Library: ${{ needs.cuda-shared-library.result }}"
          echo "CUDA Mixed Integer Type: ${{ needs.cuda-mixedint.result }}"
          echo "CUDA Single Precision: ${{ needs.cuda-single-precision.result }}"

          if [[ "${{ needs.cuda-version-matrix.result }}" != "success" ]] || \
             [[ "${{ needs.cuda-shared-library.result }}" != "success" ]] || \
             [[ "${{ needs.cuda-mixedint.result }}" != "success" ]] || \
             [[ "${{ needs.cuda-single-precision.result }}" != "success" ]]; then
            echo "::error::One or more CUDA CI jobs failed"
            exit 1
          fi
          echo "All CUDA CI jobs passed successfully!"

